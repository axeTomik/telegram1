<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BeautyBook</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            width: 200px;
        }
        .section {
            border: 1px solid #eee;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth" class="hidden">
        <div class="section">
            <button onclick="handleAuth()">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div id="loading" class="section">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="client-view" class="hidden">
        <div class="section">
            <h2>üîç –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤</h2>
            <input type="text" id="city" placeholder="–í–∞—à –≥–æ—Ä–æ–¥">
            <select id="service">
                <option value="nails">üíÖ –ú–∞–Ω–∏–∫—é—Ä</option>
                <option value="lashes">üëÅ –ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü</option>
                <option value="brows">‚úÇÔ∏è –ë—Ä–æ–≤–∏</option>
            </select>
            <button onclick="searchMasters()">–ü–æ–∏—Å–∫</button>
        </div>

        <div class="section" id="masters-list"></div>
        
        <div class="section hidden" id="booking-section">
            <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h3>
            <div id="master-schedule"></div>
        </div>

        <div class="section" id="client-bookings">
            <button onclick="loadClientBookings()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–æ–∏ –∑–∞–ø–∏—Å–∏</button>
            <div id="bookings-list"></div>
        </div>
    </div>

    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–∞—Å—Ç–µ—Ä–∞ -->
    <div id="master-view" class="hidden">
        <div class="section">
            <h2>üë©üé® –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h2>
            <button onclick="showSection('schedule')">üóì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
            <button onclick="showSection('services')">üíº –£—Å–ª—É–≥–∏</button>
            <button onclick="showSection('bookings')">üìã –ó–∞–ø–∏—Å–∏</button>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º -->
        <div class="section" id="schedule-section">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</h3>
            <input type="date" id="slot-date">
            <input type="time" id="start-time">
            <input type="time" id="end-time">
            <button onclick="addTimeSlot()">–î–æ–±–∞–≤–∏—Ç—å</button>
            
            <h3>üìÖ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–ª–æ—Ç—ã</h3>
            <div id="slots-list"></div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ -->
        <div class="section hidden" id="services-section">
            <h3>üéØ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</h3>
            <input type="text" id="service-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="number" id="service-price" placeholder="–¶–µ–Ω–∞">
            <button onclick="addService()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <div id="services-list"></div>
        </div>

        <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π -->
        <div class="section hidden" id="bookings-section">
            <h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h3>
            <div id="pending-bookings"></div>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
let user = null;
let currentMaster = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    if (tg.initDataUnsafe.user) {
        user = tg.initDataUnsafe.user;
        checkUserRole();
        tg.expand();
    } else {
        document.getElementById('auth').classList.remove('hidden');
        document.getElementById('loading').classList.add('hidden');
    }
});

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
function handleAuth() {
    tg.openTelegramLink(tg.initDataUnsafe.start_param 
        ? `https://t.me/${tg.initDataUnsafe.bot.username}?start=${tg.initDataUnsafe.start_param}`
        : `https://t.me/${tg.initDataUnsafe.bot.username}`);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
async function checkUserRole() {
    try {
        const response = await fetch('/api/user-role', {
            headers: { 'X-Telegram-User': JSON.stringify(user) }
        });
        const data = await response.json();
        
        document.getElementById('loading').classList.add('hidden');
        
        if (data.role === 'master') {
            document.getElementById('master-view').classList.remove('hidden');
            loadMasterData();
        } else {
            document.getElementById('client-view').classList.remove('hidden');
        }
    } catch (error) {
        tg.showAlert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }
}

// ================== –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ================== //
async function searchMasters() {
    const city = document.getElementById('city').value;
    const service = document.getElementById('service').value;
    
    try {
        const response = await fetch(`/api/masters?city=${city}&service=${service}`);
        const masters = await response.json();
        
        let html = '';
        masters.forEach(master => {
            html += `
                <div class="section">
                    <h4>${master.name} ‚òÖ${master.rating}</h4>
                    <button onclick="showMasterSchedule(${master.id})">–í—ã–±—Ä–∞—Ç—å</button>
                </div>
            `;
        });
        
        document.getElementById('masters-list').innerHTML = html;
    } catch (error) {
        tg.showAlert('üö´ –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
    }
}

async function showMasterSchedule(masterId) {
    try {
        const response = await fetch(`/api/master/${masterId}/slots`);
        const slots = await response.json();
        
        let html = '<ul>';
        slots.forEach(slot => {
            html += `
                <li>
                    ${slot.date} ${slot.start}-${slot.end}
                    <button onclick="bookSlot(${slot.id})">üìå –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
                </li>
            `;
        });
        
        document.getElementById('master-schedule').innerHTML = html;
        document.getElementById('booking-section').classList.remove('hidden');
    } catch (error) {
        tg.showAlert('üö´ –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
    }
}

// ================== –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ ================== //
async function addTimeSlot() {
    const date = document.getElementById('slot-date').value;
    const start = document.getElementById('start-time').value;
    const end = document.getElementById('end-time').value;

    if (!date || !start || !end) {
        tg.showAlert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
        return;
    }

    try {
        const response = await fetch('/api/master/slots', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Telegram-User': JSON.stringify(user)
            },
            body: JSON.stringify({ date, start, end })
        });

        if (response.ok) {
            const slots = await response.json();
            renderSlots(slots);
            tg.showAlert('‚úÖ –°–ª–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
        }
    } catch (error) {
        tg.showAlert('üö´ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

async function loadMasterBookings() {
    try {
        const response = await fetch('/api/master/bookings');
        const bookings = await response.json();
        
        let html = '<ul>';
        bookings.forEach(booking => {
            html += `
                <li>
                    ${booking.date} ${booking.time} 
                    üë§ ${booking.client_name}
                    <button onclick="confirmBooking(${booking.id})">‚úÖ</button>
                    <button onclick="cancelBookingMaster(${booking.id})">‚ùå</button>
                </li>
            `;
        });
        document.getElementById('pending-bookings').innerHTML = html;
    } catch (error) {
        tg.showAlert('üö´ –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    }
}

// ================== –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ================== //
function showSection(section) {
    ['schedule', 'services', 'bookings'].forEach(id => {
        document.getElementById(`${id}-section`).classList.add('hidden');
    });
    document.getElementById(`${section}-section`).classList.remove('hidden');
}

async function safeFetch(url, options) {
    try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(response.statusText);
        return await response.json();
    } catch (error) {
        tg.showAlert(`üö´ –û—à–∏–±–∫–∞: ${error.message}`);
        throw error;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
const socket = new WebSocket(`wss://${window.location.host}/ws`);
socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'booking_update') loadClientBookings();
};
</script>
</body>
</html>