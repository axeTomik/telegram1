<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BeautyBook</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --light: #f8f9fa;
            --dark: #343a40;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--light);
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .active {
            display: block !important;
        }

        .header {
            text-align: center;
            margin: 30px 0;
        }

        .master-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .select-group {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin: 20px 0;
        }

        select, .action-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="homeScreen" class="screen active">
        <button class="master-btn" onclick="showMasterScreen()">üé® –ú–∞—Å—Ç–µ—Ä</button>
        
        <div class="header">
            <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username"></span></h1>
        </div>

        <div class="select-group">
            <select id="citySelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                <option value="–í–æ—Ä–æ–Ω–µ–∂">–í–æ—Ä–æ–Ω–µ–∂</option>
                <option value="–°—Ç–∞—Ä—ã–π –û—Å–∫–æ–ª">–°—Ç–∞—Ä—ã–π –û—Å–∫–æ–ª</option>
                <option value="–ì—É–±–∫–∏–Ω">–ì—É–±–∫–∏–Ω</option>
                <option value="–ë–µ–ª–≥–æ—Ä–æ–¥">–ë–µ–ª–≥–æ—Ä–æ–¥</option>
            </select>
            
            <button class="action-btn" onclick="selectCity()">–í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥</button>
        </div>
    </div>

    <div id="serviceScreen" class="screen">
        <div class="select-group">
            <select id="serviceSelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
                <option value="nails">üíÖ –ù–æ–≥—Ç–∏</option>
                <option value="lashes">üëÅÔ∏è –†–µ—Å–Ω–∏—Ü—ã</option>
                <option value="brows">‚úÇÔ∏è –ë—Ä–æ–≤–∏</option>
            </select>
            
            <button class="action-btn" onclick="selectService()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <div id="mastersScreen" class="screen">
        <div class="header">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞</h2>
            <p>üìç <span id="currentCity"></span> | üíº <span id="currentService"></span></p>
        </div>
        
        <div id="mastersList" class="select-group"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const backendUrl = '–í–ê–®_–ë–≠–ö–ï–ù–î_URL';
        let currentUser = {};
        let currentCity = '';
        let currentService = '';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            tg.ready();
            tg.expand();
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const initData = urlParams.get('init_data');
            const hash = urlParams.get('hash');

            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            try {
                const authResponse = await fetch(`${backendUrl}/api/auth`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ init_data: initData, hash: hash })
                });
                
                if (!authResponse.ok) throw new Error('Auth failed');
                
                const { user_id } = await authResponse.json();
                currentUser.id = user_id;
                loadUserData(user_id);
                
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData(userId) {
            try {
                const response = await fetch(`${backendUrl}/api/user-role?tg_id=${userId}`);
                const { role } = await response.json();
                document.getElementById('username').textContent = `@user_${userId}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞
        function selectCity() {
            currentCity = document.getElementById('citySelect').value;
            if (!currentCity) return tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
            showScreen('serviceScreen');
        }

        // –í—ã–±–æ—Ä —É—Å–ª—É–≥–∏
        async function selectService() {
            currentService = document.getElementById('serviceSelect').value;
            if (!currentService) return tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É');
            
            try {
                const response = await fetch(
                    `${backendUrl}/api/masters?city=${encodeURIComponent(currentCity)}&service=${currentService}`
                );
                
                if (!response.ok) throw new Error('Server error');
                
                const masters = await response.json();
                renderMasters(masters);
                showScreen('mastersScreen');
                
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
        function renderMasters(masters) {
            const list = document.getElementById('mastersList');
            document.getElementById('currentCity').textContent = currentCity;
            document.getElementById('currentService').textContent = 
                document.querySelector(`#serviceSelect option[value="${currentService}"]`).textContent;

            list.innerHTML = masters.map(master => `
                <div style="padding: 15px; margin: 10px 0; background: white; border-radius: 10px;">
                    <h3>${master.name || '–ú–∞—Å—Ç–µ—Ä'}</h3>
                    <p>üí∞ –¶–µ–Ω–∞: ${master.price} —Ä—É–±.</p>
                    <p>‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${master.duration} –º–∏–Ω.</p>
                    ${master.bio ? `<p>${master.bio}</p>` : ''}
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
