<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BeautyBook</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --error: #dc3545;
            --success: #28a745;
            --text: #2c3e50;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: var(--text);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .role-switch {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .slot {
            padding: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: 0.2s;
        }

        .slot.booked {
            background: #ffcccc;
            cursor: not-allowed;
        }

        .slot.selected {
            background: #cce5ff;
        }

        .service-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π -->
        <div class="role-switch">
            <button id="switchRoleBtn" class="button" onclick="switchRole()">–í–æ–π—Ç–∏ –∫–∞–∫ –º–∞—Å—Ç–µ—Ä</button>
        </div>

        <!-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="clientInterface" class="tab-content active">
            <div class="section">
                <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username"></span></h1>
                <input type="text" id="cityInput" placeholder="–í–∞—à –≥–æ—Ä–æ–¥">
                <select id="serviceCategory">
                    <option value="nails">üíÖ –ù–æ–≥—Ç–∏</option>
                    <option value="lashes">üëÅÔ∏è –†–µ—Å–Ω–∏—Ü—ã</option>
                    <option value="brows">‚úÇÔ∏è –ë—Ä–æ–≤–∏</option>
                </select>
                <button class="button" onclick="searchMasters()">–ù–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–æ–≤</button>
            </div>

            <div id="mastersList" class="section"></div>
            <div id="bookingCalendar" class="section hidden"></div>
        </div>

        <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–∞—Å—Ç–µ—Ä–∞ -->
        <div id="masterInterface" class="tab-content">
            <div class="section">
                <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º</h2>
                <input type="text" id="masterBio" placeholder="–û —Å–µ–±–µ">
                <input type="text" id="masterContacts" placeholder="Telegram @username">
                <button class="button" onclick="saveMasterProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="section">
                <h2>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
                <div id="calendarContainer"></div>
                <button class="button" onclick="showTemplateModal()">–®–∞–±–ª–æ–Ω—ã</button>
            </div>

            <div class="section">
                <h2>üìù –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏</h2>
                <div id="masterBookings"></div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const backendUrl = 'https://dumbly-miraculous-chamois.cloudpub.ru';
        let currentMasterId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.ready();
        tg.expand();
        tg.MainButton.hide();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initApp() {
            const user = tg.initDataUnsafe.user;
            document.getElementById('username').textContent = `@${user.username}`;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
            const response = await fetch(`${backendUrl}/api/user-role?tg_id=${user.id}`);
            const data = await response.json();
            
            if(data.role === 'master') {
                document.getElementById('switchRoleBtn').textContent = '–†–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞';
                showMasterInterface();
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–∏
        async function switchRole() {
            const user = tg.initDataUnsafe.user;
            const response = await fetch(`${backendUrl}/api/switch-role`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tg_id: user.id})
            });

            if(response.ok) location.reload();
        }

        // –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤
        async function searchMasters() {
            const params = new URLSearchParams({
                city: document.getElementById('cityInput').value,
                service: document.getElementById('serviceCategory').value
            });

            const response = await fetch(`${backendUrl}/api/masters?${params}`);
            const masters = await response.json();

            document.getElementById('mastersList').innerHTML = masters.map(master => `
                <div class="service-card" onclick="showMasterCalendar(${master.id})">
                    <h3>${master.name}</h3>
                    <p>üí∞ ${master.price} —Ä—É–±. / ‚è± ${master.duration} –º–∏–Ω.</p>
                </div>
            `).join('');
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –º–∞—Å—Ç–µ—Ä–∞
        async function showMasterCalendar(masterId) {
            currentMasterId = masterId;
            const response = await fetch(`${backendUrl}/api/master/${masterId}/slots`);
            const slots = await response.json();

            const calendarHTML = slots.map(slot => `
                <div class="slot ${slot.status}" 
                     data-time="${slot.start_time}"
                     onclick="selectSlot(this, '${slot.id}')">
                    ${new Date(slot.start_time).toLocaleTimeString()}
                </div>
            `).join('');

            document.getElementById('bookingCalendar').innerHTML = calendarHTML;
            document.getElementById('bookingCalendar').classList.remove('hidden');
        }

        // –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–∞
        async function bookSlot(slotId) {
            const user = tg.initDataUnsafe.user;
            
            const response = await fetch(`${backendUrl}/api/bookings`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    client_id: user.id,
                    master_id: currentMasterId,
                    slot_id: slotId
                })
            });

            if(response.ok) tg.showAlert('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
